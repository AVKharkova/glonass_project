# Клиент для API GlonassSoft с сохранением данных в SQLite

Проект представляет собой Python-скрипт для взаимодействия с API GlonassSoft. Он позволяет автоматизировать запросы к различным эндпоинтам API, включая аутентификацию, получение данных об объектах мониторинга (транспортных средствах), их детальной информации, датчиках, отчетах по пробегу, топливу, событиям движения и стоянок. Скрипт выполняет логирование всех запросов и ответов, валидацию ответов API с использованием Pydantic моделей и сохраняет полученные данные в локальную базу данных SQLite.

## Особенности

*   **Аутентификация**: Автоматическое получение и использование токена авторизации (`X-Auth`).
*   **Комплексный сбор данных**:
    *   Получение списка всех доступных транспортных средств.
    *   Запрос детальной информации для каждого транспортного средства, включая основные параметры, счетчики, датчики, назначенных водителей и историю статусов.
    *   Запросы отчетов:
        *   Пробег и моточасы (по умолчанию за последние 30 дней, с ежедневной детализацией).
        *   Расход топлива (по умолчанию за последние 30 дней, с ежедневной детализацией).
        *   Заправки и сливы (по умолчанию за последние 30 дней).
        *   События движения и стоянок (по умолчанию за последние 30 дней).
    *   Получение последних актуальных данных по объектам.
    *   Получение справочной информации (типы устройств, типы датчиков, список водителей клиента).
*   **Сохранение в SQLite**: Все полученные и валидированные данные сохраняются в локальную базу данных SQLite (`glonass_data.sqlite`) для последующего анализа или использования. Структура БД включает таблицы для ТС, их деталей, датчиков, отчетов и справочников.
*   **Логирование**: Подробное логирование запросов, ответов и ошибок как в консоль, так и в файл (`api_calls_ru_validated_db.log`) с кодировкой UTF-8.
*   **Управление задержками и повторами**:
    *   Настраиваемые задержки между запросами для предотвращения превышения лимитов API.
    *   Механизм повторных запросов с экспоненциальной задержкой при получении ответа `429 Too Many Requests`.
    *   Увеличенный таймаут для "тяжелых" запросов отчетов.
*   **Валидация ответов**: Использование Pydantic моделей для валидации структуры и типов данных в ответах API.
*   **Конфигурация через `.env`**: Удобное управление учетными данными, URL API и другими параметрами через файл `.env`.

## Требования

*   Python 3.8+
*   pip (менеджер пакетов Python)

## Установка

1.  **Клонируйте репозиторий (если применимо):**
    ```bash
    git clone https://github.com/AVKharkova/glonass_project.git
    cd glonass_project
    ```

2.  **Установите зависимости:**
    Создайте виртуальное окружение (рекомендуется):
    ```bash
    python -m venv venv
    ```
    Активируйте виртуальное окружение:
    *   Windows: `venv\Scripts\activate`
    *   macOS/Linux: `source venv/bin/activate`

    Установите необходимые пакеты (создайте файл `requirements.txt` со следующим содержимым или установите пакеты вручную):
    ```
    requests
    pydantic
    python-dotenv
    ```
    Затем выполните:
    ```bash
    pip install -r requirements.txt
    ```
    Или установите вручную:
    ```bash
    pip install requests pydantic python-dotenv
    ```

## Конфигурация

1.  **Создайте файл `.env`** в корневой директории проекта со следующими переменными:

    ```dotenv
    API_LOGIN=your_glonasssoft_login
    API_PASSWORD=your_glonasssoft_password
    API_BASE_URL=https://hosting.glonasssoft.ru/api/v3 # Пример URL, может отличаться
    ```

2.  **Замените `your_glonasssoft_login`, `your_glonasssoft_password`** и другие значения-плейсхолдеры на ваши реальные данные.

## Структура проекта

*   `glonass_api_client.py`: Основной исполняемый скрипт клиента (или ваше актуальное имя файла).
*   `glonass_schemas.py`: Файл с Pydantic моделями для валидации данных API.
*   `.env`: Файл для хранения учетных данных и конфигурации.
*   `api_calls_ru_validated_db.log`: Файл, в который записываются логи выполнения скрипта.
*   `glonass_data.sqlite`: Файл базы данных SQLite, создаваемый скриптом для хранения данных.

## Использование

Для запуска скрипта выполните команду в терминале, находясь в корневой директории проекта (и с активированным виртуальным окружением):

```bash
python glonass_api_client.py
```
Скрипт последовательно выполнит следующие действия:
Аутентифицируется в API.
Получит список всех доступных транспортных средств.
Для каждого ТС запросит и сохранит детальную информацию.
Выполнит запросы к различным эндпоинтам для получения отчетов и справочной информации за указанный период (по умолчанию 30 дней).
Все полученные данные будут сохранены в glonass_data.sqlite.
Логи операций будут записаны в api_calls_ru_validated_db.log и выведены в консоль.
Примечание: При первом запуске или после изменений в структуре таблиц рекомендуется удалить существующий файл glonass_data.sqlite, чтобы таблицы были созданы с актуальной схемой.

---
## Автор
**[Анастасия Харькова](https://github.com/AVKharkova)**