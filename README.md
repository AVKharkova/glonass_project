# Клиент для API GlonassSoft с сохранением данных в SQLite

Проект представляет собой Python-скрипт для взаимодействия с API GlonassSoft. Он позволяет автоматизировать запросы к различным эндпоинтам API, включая аутентификацию, получение данных об объектах мониторинга (транспортных средствах), их детальной информации, датчиках, отчетах по пробегу, топливу, событиям движения и стоянок. Скрипт выполняет логирование всех запросов и ответов, валидацию ответов API с использованием Pydantic моделей и сохраняет полученные данные в локальную базу данных SQLite.

## Особенности

*   **Аутентификация**: Автоматическое получение и использование токена авторизации (`X-Auth`).
*   **Комплексный сбор данных**:
    *   Получение списка всех доступных транспортных средств.
    *   Запрос детальной информации для каждого транспортного средства, включая основные параметры, счетчики, датчики, назначенных водителей и историю статусов.
    *   Запросы отчетов:
        *   Пробег и моточасы (по умолчанию за последние 30 дней, с ежедневной детализацией).
        *   Расход топлива (по умолчанию за последние 30 дней, с ежедневной детализацией).
        *   Заправки и сливы (по умолчанию за последние 30 дней).
        *   События движения и стоянок (по умолчанию за последние 30 дней).
    *   Получение последних актуальных данных по объектам.
    *   Получение справочной информации (типы устройств, типы датчиков, список водителей клиента).
*   **Сохранение в базу данных**: Все полученные и валидированные данные сохраняются в локальную базу данных SQLite (`glonass_data.sqlite`) или PostgreSQL (в зависимости от конфигурации) для последующего анализа или использования. Структура БД включает таблицы для ТС, их деталей, датчиков, отчетов и справочников.
*   **Логирование**: Подробное логирование запросов, ответов и ошибок как в консоль, так и в файл (`api_calls_ru_validated_db.log`) с кодировкой UTF-8.
*   **Управление задержками и повторами**:
    *   Настраиваемые задержки между запросами для предотвращения превышения лимитов API.
    *   Механизм повторных запросов с экспоненциальной задержкой при получении ответа `429 Too Many Requests`.
    *   Увеличенный таймаут для "тяжелых" запросов отчетов.
*   **Валидация ответов**: Использование Pydantic моделей для валидации структуры и типов данных в ответах API.
*   **Конфигурация через `.env`**: Удобное управление учетными данными, URL API и другими параметрами через файл `.env`.
* **Поддержка двух типов баз данных**:
  * SQLite: Локальная файловая база данных, не требующая настройки сервера.
  * PostgreSQL: Серверная база данных для более сложных сценариев и масштабируемости.

## Требования

*   Python 3.8+
*   pip (менеджер пакетов Python)
*   PostgreSQL (если используется, версия 10+ рекомендуется)
*   SQLite (встроен в Python, дополнительная установка не требуется)

## Установка

1.  **Клонируйте репозиторий (если применимо):**
    ```bash
    git clone https://github.com/AVKharkova/glonass_project.git
    cd glonass_project
    ```

2.  **Установите зависимости:**
    Создайте виртуальное окружение (рекомендуется):
    ```bash
    python -m venv venv
    ```
    Активируйте виртуальное окружение:
    *   Windows: `venv\Scripts\activate`
    *   macOS/Linux: `source venv/bin/activate`

    Установите необходимые пакеты:
    ```bash
    pip install -r requirements.txt
    ```
    Или установите вручную:
    ```bash
    pip install requests pydantic python-dotenv psycopg2-binary sqlalchemy
    ```

## Конфигурация

1.  **Создайте файл `.env`** в корневой директории проекта со следующими переменными:

    ```dotenv
    # Параметры API
    API_LOGIN=your_glonasssoft_login
    API_PASSWORD=your_glonasssoft_password
    API_BASE_URL=https://hosting.glonasssoft.ru/api/v3  # Пример URL, может отличаться

    # Параметры базы данных
    DB_TYPE=sqlite  # Тип базы данных: 'sqlite' или 'postgres'
    SQLITE_DB_FILE=glonass_data.sqlite  # Путь к файлу SQLite (используется, если DB_TYPE=sqlite)

    # Параметры подключения к PostgreSQL (используются, если DB_TYPE=postgres)
    PG_HOST=localhost
    PG_PORT=5432
    PG_DB_NAME=glonass_db
    PG_USER=glonass_user
    PG_PASSWORD=glonass_password
    ```

2.  **Замените значения-плейсхолдеры на ваши реальные данные:
    *   your_glonasssoft_login, your_glonasssoft_password — ваши учетные данные для API GlonassSoft.
    *   API_BASE_URL — базовый URL API, если отличается от указанного.
    *   DB_TYPE — укажите sqlite для локальной базы данных или postgres для серверной PostgreSQL.
    *   SQLITE_DB_FILE — имя файла SQLite, если используется SQLite.
    *   PG_* — параметры подключения к PostgreSQL, если используется PostgreSQL.


## Сценарии работы с базой данных
Скрипт поддерживает два сценария работы с базой данных, которые определяются параметром DB_TYPE в файле .env:

### SQLite (DB_TYPE=sqlite):

Описание: Данные сохраняются в локальный файл SQLite (glonass_data.sqlite или имя, указанное в SQLITE_DB_FILE). Этот сценарий подходит для локального использования, тестирования или небольших объемов данных, так как не требует настройки серверной базы данных.
Особенности:
Автоматическое создание файла базы данных при первом запуске.
Простота использования, так как SQLite встроен в Python.
Подходит для однопользовательских приложений.
Ограничения по производительности при больших объемах данных.
Конфигурация: Убедитесь, что DB_TYPE=sqlite и SQLITE_DB_FILE указывает на существующий или создаваемый путь к файлу.
Примечание: При каждом запуске скрипт удаляет существующий файл SQLite (если он есть) и создает новый для обеспечения актуальной схемы.

### PostgreSQL (DB_TYPE=postgres):

Описание: Данные сохраняются в серверную базу данных PostgreSQL, что подходит для масштабируемых приложений, многопользовательского доступа или работы с большими объемами данных.
Особенности:
Требуется установленный и настроенный сервер PostgreSQL.
Поддержка сложных запросов, транзакций и высокой производительности.
Использует SQLAlchemy и psycopg2 для взаимодействия с базой.
Таблицы создаются автоматически при первом запуске, если они не существуют.
Конфигурация:
Убедитесь, что DB_TYPE=postgres.
Настройте параметры PG_HOST, PG_PORT, PG_DB_NAME, PG_USER, PG_PASSWORD в .env для подключения к вашему серверу PostgreSQL.
Убедитесь, что база данных и пользователь созданы, а пользователь имеет права на создание и изменение таблиц в указанной базе.
Примечание: Скрипт использует ON CONFLICT для обработки дублирующихся записей в PostgreSQL, что обеспечивает безопасное обновление данных.

## Структура проекта

*   `glonass_api_client.py`: Основной исполняемый скрипт клиента (или ваше актуальное имя файла).
*   `glonass_schemas.py`: Файл с Pydantic моделями для валидации данных API.
*   `.env`: Файл для хранения учетных данных и конфигурации.
*   `api_calls_ru_validated_db.log`: Файл, в который записываются логи выполнения скрипта.
*   `glonass_data.sqlite`: Файл базы данных SQLite, создаваемый скриптом, если используется SQLite.
*   (Для PostgreSQL) Данные сохраняются в указанную базу данных (glonass_db или имя, заданное в PG_DB_NAME).

## Использование

Для запуска скрипта выполните команду в терминале, находясь в корневой директории проекта (и с активированным виртуальным окружением):

```bash
python glonass_api_client.py
```

Скрипт последовательно выполнит следующие действия:
*   Аутентифицируется в API.
*   Получит список всех доступных транспортных средств.
*   Для каждого ТС запросит и сохранит детальную информацию.
*   Выполнит запросы к различным эндпоинтам для получения отчетов и справочной информации за указанный период (по умолчанию 30 дней).
*   Все полученные данные будут сохранены в базу данных (SQLite или PostgreSQL, в зависимости от DB_TYPE).
*   Логи операций будут записаны в api_calls_ru_validated_db.log и выведены в консоль.

Примечание: Для SQLite: При первом запуске или после изменений в структуре таблиц рекомендуется удалить существующий файл glonass_data.sqlite, чтобы таблицы были созданы с актуальной схемой.
Для PostgreSQL: Убедитесь, что сервер PostgreSQL запущен, база данных доступна, и параметры подключения в .env корректны.

---
## Автор
**[Анастасия Харькова](https://github.com/AVKharkova)**